<!DOCTYPE html>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<html>

<head>
    <meta charset="UTF-8" />
    <title>2dland 6盘（清真云）</title>
    <link rel="stylesheet" type="text/css" href="https://www.unpkg.com/bootstrap@5.3.3/dist/css/bootstrap.min.css" />
    <link href="https://cdn.jsdelivr.net/npm/@mdi/font@7.4.47/css/materialdesignicons.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/roboto-font@0.1.0/css/fonts.min.css" rel="stylesheet" />
    <link href="//unpkg.com/layui@2.9.21/dist/css/layui.css" rel="stylesheet">
</head>

<body style="height:100%;">
    <div id="root"></div>
    <a id="back-to-top" href="#" class="btn btn-success btn-lg back-to-top" role="button"><i
            class="mdi mdi-arrow-up"></i></a>
    <script crossorigin src="https://unpkg.com/react@18.3.1/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18.3.1/umd/react-dom.production.min.js"></script>
    <script src="https://www.unpkg.com/jquery@3.7.1/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"></script>
    <script src="https://www.unpkg.com/bootstrap@5.3.3/dist/js/bootstrap.min.js"></script>
    <script src="https://unpkg.com/react-bootstrap@2.10.7/dist/react-bootstrap.min.js"></script>
    <script src="https://unpkg.com/redux@4.2.1/dist/redux.min.js"></script>
    <script src="https://unpkg.com/react-router-dom@5.3.0/umd/react-router-dom.min.js"></script>
    <script src="https://unpkg.com/babel-standalone@6.26.0/babel.min.js"></script>
    <script src="https://unpkg.com/regenerator-runtime@0.14.1/runtime.js"></script>
    <script src="https://unpkg.com/@babel/polyfill@7.12.1/dist/polyfill.min.js"></script>
    <script src="https://unpkg.com/axios@1.7.9/dist/axios.min.js"></script>
    <script src="https://unpkg.com/layui@2.9.21/dist/layui.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ajv/8.17.1/ajv7.min.js"></script>
    <script src="https://unpkg.com/@tanstack/react-query@4.36.1/build/umd/index.production.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mitt@3.0.1/dist/mitt.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/localforage/1.10.0/localforage.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0/dist/fancybox/fancybox.umd.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0/dist/fancybox/fancybox.css" />
    <script src="https://unpkg.com/clipboard@2/dist/clipboard.min.js"></script>

    <style>
        .bi {
            display: inline-block;
            width: 1rem;
            height: 1rem;
        }

        /*
   * Sidebar
   */
        @media (min-width: 768px) {
            .sidebar {
                width: 100%;
            }

            .sidebar .offcanvas-lg {
                position: -webkit-sticky;
                position: sticky;
                top: 48px;
            }

            .navbar-search {
                display: block;
            }
        }

        .sidebar .nav-link {
            font-size: 0.875rem;
            font-weight: 500;
        }

        .sidebar .nav-link.active {
            color: #2470dc;
        }

        .sidebar-heading {
            font-size: 0.75rem;
        }

        /*
   * Navbar
   */
        .navbar {
            background-color: teal;
        }

        .navbar-brand {
            padding-top: 0.75rem;
            padding-bottom: 0.75rem;
            /* background-color: rgba(0, 0, 0, .25); 
    box-shadow: inset -1px 0 0 rgba(0, 0, 0, .25); */
        }

        .navbar .form-control {
            padding: 0.75rem 1rem;
        }

        .bd-placeholder-img {
            font-size: 1.125rem;
            text-anchor: middle;
            -webkit-user-select: none;
            -moz-user-select: none;
            user-select: none;
        }

        @media (min-width: 768px) {
            .bd-placeholder-img-lg {
                font-size: 3.5rem;
            }
        }

        .b-example-divider {
            width: 100%;
            height: 3rem;
            background-color: rgba(0, 0, 0, 0.1);
            border: solid rgba(0, 0, 0, 0.15);
            border-width: 1px 0;
            box-shadow: inset 0 0.5em 1.5em rgba(0, 0, 0, 0.1),
                inset 0 0.125em 0.5em rgba(0, 0, 0, 0.15);
        }

        .b-example-vr {
            flex-shrink: 0;
            width: 1.5rem;
            height: 100vh;
        }

        .bi {
            vertical-align: -0.125em;
            fill: currentColor;
        }

        .nav-scroller {
            position: relative;
            z-index: 2;
            height: 2.75rem;
            overflow-y: hidden;
        }

        .nav-scroller .nav {
            display: flex;
            flex-wrap: nowrap;
            padding-bottom: 1rem;
            margin-top: -1px;
            overflow-x: auto;
            text-align: center;
            white-space: nowrap;
            -webkit-overflow-scrolling: touch;
        }

        .btn-bd-primary {
            --bd-violet-bg: #712cf9;
            --bd-violet-rgb: 112.520718, 44.062154, 249.437846;

            --bs-btn-font-weight: 600;
            --bs-btn-color: var(--bs-white);
            --bs-btn-bg: var(--bd-violet-bg);
            --bs-btn-border-color: var(--bd-violet-bg);
            --bs-btn-hover-color: var(--bs-white);
            --bs-btn-hover-bg: #6528e0;
            --bs-btn-hover-border-color: #6528e0;
            --bs-btn-focus-shadow-rgb: var(--bd-violet-rgb);
            --bs-btn-active-color: var(--bs-btn-hover-color);
            --bs-btn-active-bg: #5a23c8;
            --bs-btn-active-border-color: #5a23c8;
        }

        .bd-mode-toggle {
            z-index: 1500;
        }

        .bd-mode-toggle .dropdown-menu .active .bi {
            display: block !important;
        }

        .back-to-top {
            position: fixed;
            bottom: 25px;
            right: 25px;
            display: none;
        }

        .leftsidebar {
            height: 100%;
            box-shadow: inset -1px 0 0 rgba(0, 0, 0, 0.1);
        }

        @media (min-width: 768px) {
            .leftsidebar {
                min-width: 15%;
            }
        }

        @media (max-width: 768px) {
            .leftsidebar {
                max-width: 50%;
            }
        }

        .bg-teal {
            background-color: teal;
        }
    </style>

    <script type="text/babel" data-presets="react" data-type="module">
        window.layer = layui.layer;
        //事件监听开始  通过修改localstorage实现跨页面事件监听
        const emitter = mitt();
        // 监听 localStorage 变化
        window.addEventListener("storage", (event) => {
            if (event.key === "event") {
                const { type, data } = JSON.parse(event.newValue);
                emitter.emit(type, data);
            }
        });
        // 封装 emit 方法
        const emitEvent = (type, data) => {
            // 触发本地事件
            emitter.emit(type, data);
            const randomString = Math.random()
                .toString(36)
                .substring(2, 10); // 生成一个随机字符串确保event每次的值不一样，如果一样会不触发事件
            const identity = `${Date.now()}-${randomString}`;
            // 存储到 localStorage，以便其他页面能够接收到
            localStorage.setItem(
                "event",
                JSON.stringify({ type, data, identity })
            );
        };

        // 封装 on 方法
        const onEvent = (type, callback) => {
            emitter.on(type, callback);
        };

        // 封装 off 方法
        const offEvent = (type, callback) => {
            emitter.off(type, callback);
        };
        //事件监听结束


        Fancybox.bind("[data-fancybox]", {
            Toolbar: {
                display: {
                    right: ["slideshow", "download", "thumbs", "close"],
                },
            },
            Images: {
                initialSize: "fit",
            }
        });


        var settingStorage = localforage.createInstance({
            name: "setting",
            driver: localforage.LOCALSTORAGE
        });
        // settingStorage.setItem("category", { name: 'test', id: 1 });
        // settingStorage.getItem('category').then(function (value) {
        // 	console.log(value);
        // }).catch(function (err) {
        // 	console.log(err);
        // });
        // settingStorage.getItem('category', function (err, value) {
        // 	console.log(value.name);
        // });
        axios.interceptors.request.use(
            async function (config) {
                if (!config.url.includes('/api/login')) {
                    const value = await settingStorage.getItem('auth_info');
                    if (value) {
                        if (value.hasOwnProperty('access_token')) {
                            config.headers['Refresh-Token'] = `${value.refresh_token}`;
                            config.headers['Access-Token'] = `${value.access_token}`;
                            config.headers['Access-Token-Expired-At'] = `${value.expire_at}`;
                        } else {
                            config.headers['Refresh-Token'] = `${value.refresh_token}`;
                            config.headers['Access-Token'] = "";
                            config.headers['Access-Token-Expired-At'] = 0;
                        }
                    }
                }
                if (!config.headers['Content-Type']) {
                    config.headers['Content-Type'] = 'application/json';
                }
                return config;
            },
            function (error) {
                // 请求错误处理
                return Promise.reject(error);
            }
        );
        axios.interceptors.response.use(
            function (response) {
                // 如果返回的结果中有 auth_info 字段
                if (response.data && response.data.auth_info) {
                    settingStorage.setItem('auth_info', response.data.auth_info)
                }
                // 返回响应数据
                return response;
            },
            function (error) {
                // 错误处理
                console.error('Response Error:', error);
                return Promise.reject(error);
            }
        );



        const { createStore, combineReducers } = Redux;
        // 从 localStorage 加载初始状态
        const loadStateFromLocalStorage = () => {
            try {
                const serializedState = localStorage.getItem('settings');
                if (serializedState === null) {
                    return {}; // 默认值
                }
                return JSON.parse(serializedState);
            } catch (e) {
                console.error("Could not load state from localStorage:", e);
                return {}; // 默认值
            }
        };
        // 保存状态到 localStorage
        const saveStateToLocalStorage = (state) => {
            try {
                const serializedState = JSON.stringify(state);
                localStorage.setItem('settings', serializedState);
            } catch (e) {
                console.error("Could not save state to localStorage:", e);
            }
        };

        // 定义初始状态
        const initialSettingsState = loadStateFromLocalStorage();
        // 创建 settings Reducer
        function settingsReducer(state = initialSettingsState, action) {
            switch (action.type) {
                case 'SAVE_SETTING':
                    return { ...state, ...action.payload };
                case 'RESET_SETTING':
                    return {};
                default:
                    return state;
            }
        }

        // 合并 Reducer（如果有多个）
        const rootReducer = combineReducers({
            settings: settingsReducer,
        });

        // 创建 Redux Store
        const STORE = createStore(rootReducer);

        // 订阅 Store 的变化，并将状态保存到 localStorage
        STORE.subscribe(() => {
            saveStateToLocalStorage(STORE.getState().settings);
        });

        const bytesToSize = (bytes) => {
            if (bytes === 0) return '0 B';
            var k = 1024;
            sizes = ['B', 'KB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB'];
            i = Math.floor(Math.log(bytes) / Math.log(k));
            return (bytes / Math.pow(k, i)).toFixed(2) + ' ' + sizes[i];
        };
        const formatDate = (date) => {
            var d = new Date(date);
            var year = d.getFullYear();
            var month = d.getMonth() + 1;
            var day = d.getDate() < 10 ? '0' + d.getDate() : '' + d.getDate();
            var hour = d.getHours();
            var minutes = d.getMinutes();
            var seconds = d.getSeconds();
            return year + '-' + month + '-' + day + ' ' + hour + ':' + minutes + ':' + seconds;
        };

        const pathJoin = (...args) => {
            let joinedPath = args
                .map(arg => arg.trim())  // 移除每个路径部分的空格
                .filter(arg => arg.length > 0)  // 过滤掉空字符串
                .join('/');  // 使用斜杠 / 来连接路径部分

            // 替换多余的斜杠
            joinedPath = joinedPath.replace(/\/+/g, '/');
            // 处理路径的开头和结尾部分
            // if (joinedPath.startsWith('/')) {
            //     joinedPath = '/' + joinedPath;  // 如果路径以 / 开头，保持它
            // }
            return joinedPath;
        }

        let layerLoading = null;

        const showLoading = () => {
            const loadindex = layer.load(1);
            layerLoading = loadindex;
        }

        const hideLoading = () => {
            layer.close(layerLoading);
        }


        const { useState, useEffect, useRef } = React;
        const { HashRouter, Route, Link, Switch, useLocation, useParams } = ReactRouterDOM;
        const { useQuery, useMutation, useQueryClient, QueryClient, QueryClientProvider } = ReactQuery;
        const queryClient = new QueryClient()
        const {
            Alert,
            Badge,
            Button,
            ButtonGroup,
            ButtonToolbar,
            Card,
            Collapse,
            Col,
            Container,
            Dropdown,
            Form,
            Image,
            InputGroup,
            ListGroup,
            Modal,
            Nav,
            Navbar,
            NavDropdown,
            Offcanvas,
            Pagination,
            Row,
            Table,
        } = ReactBootstrap;

        // 表格组件
        const DataTable = ({ data, columns }) => {
            return (
                <Table responsive bordered>
                    <thead>
                        <tr className="text-center">
                            {columns.map((column, index) => (
                                <th key={index}>{column.title}</th>
                            ))}
                        </tr>
                    </thead>
                    <tbody>
                        {data.map((row, rowIndex) => (
                            <tr key={rowIndex} className="text-center">
                                {columns.map((column, colIndex) => (
                                    <td key={colIndex}>
                                        {/* 调用渲染方法，如果没有定义，则直接显示数据 */}
                                        {column.render
                                            ? column.render(row)
                                            : row[column.dataIndex]}
                                    </td>
                                ))}
                            </tr>
                        ))}
                    </tbody>
                </Table>
            );
        };
        //分页组件
        const Paginate = (props) => {
            const page = props.page;
            const pageCount = Math.ceil(
                props.totalCount / props.itemsPerPage
            );

            const SelectItems = () => {
                const pageNumbers = Array.from(
                    { length: pageCount },
                    (_, i) => i + 1
                );
                return (
                    <select
                        className="page-link border-0 h-100 py-0"
                        style={{ width: "auto" }}
                        onChange={(e) => {
                            props.onClick(parseInt(e.target.value));
                        }}
                    >
                        {pageNumbers.map((number) => {
                            const selected = number === page ? true : false;
                            return (
                                <option
                                    key={number}
                                    value={number}
                                    selected={selected}
                                >
                                    {number}
                                </option>
                            );
                        })}
                    </select>
                );
            };
            return (
                <div className="d-flex justify-content-center align-items-baseline">

                    <Pagination>
                        {pageCount > 1 && page > 1 && (
                            <Pagination.First
                                onClick={() => {
                                    props.onClick(1);
                                }}
                            />
                        )}
                        {pageCount > 1 && page > 1 && (
                            <Pagination.Prev
                                onClick={() => {
                                    props.onClick(page - 1);
                                }}
                            />
                        )}
                        <Pagination.Item linkClassName="p-0 h-100 d-inline-block">
                            <SelectItems />
                        </Pagination.Item>
                        <Pagination.Item>
                            <span className="text-info">
                                {page}/{pageCount}
                            </span>
                        </Pagination.Item>
                        {pageCount > 1 && page < pageCount && (
                            <Pagination.Next
                                onClick={() => {
                                    props.onClick(page + 1);
                                }}
                            />
                        )}
                        {pageCount > 1 && page < pageCount && (
                            <Pagination.Last
                                onClick={() => {
                                    props.onClick(pageCount);
                                }}
                            />
                        )}
                    </Pagination>
                </div>
            );
        };
        //图标组件
        const Icon = (props) => {
            return (
                <span
                    onClick={props.onClick}
                    className={`mdi mdi-${props.icon} fs-${props.size} ${props.className}`}
                ></span>
            );
        };
        //按钮图标组件
        const IconButton = (props) => {
            return (
                <Button
                    variant="success"
                    onClick={props.onClick}
                    className={props.className}
                >
                    <span
                        className={`mdi mdi-${props.icon} fs-${props.iconSize} ${props.iconClassName}`}
                    ></span>
                    {props.text}
                </Button>
            );
        };
        //video组件
        const createCaption = (video) => {
            var html = video.code + ' ' + video.title;
            //html+="<a href='/tags'>test</a>";
            video.tags.map(tag => {
                html += tag;
            })
            return html;
        };


        const AsyncImage = (props) => {
            const [loadedSrc, setLoadedSrc] = React.useState(null);
            React.useEffect(() => {
                setLoadedSrc(null);
                if (props.src) {
                    const handleLoad = () => {
                        setLoadedSrc(props.src);
                    };
                    const image = document.createElement("img");
                    image.addEventListener('load', handleLoad);
                    image.src = props.src;
                    return () => {
                        image.removeEventListener('load', handleLoad);
                    };
                }
            }, [props.src]);
            if (loadedSrc === props.src) {
                return (
                    <img {...props} />
                );
            }
            return <img {...props} src="https://placehold.co/600x400?text=Loading" />;
        };

        //设置框
        const SettingModal = (props) => {
            const settings = [
                { "Token": [{ "label": "Refresh Token", "key": "refresh_token", "show": false }] },
                { "github": [{ "label": "Actions地址", "key": "github_host", "show": true }, { "label": "Github令牌", "key": "github_token", "show": false }] },
                { "directus": [{ "label": "Directus地址", "key": "directus_host", "show": true }, { "label": "Directus令牌", "key": "directus_token", "show": false }] }
            ]
            const [setting, setSetting] = useState({});
            const loadSetting = () => {
                const storedSettings = STORE.getState().settings;
                if (storedSettings) {
                    setSetting(storedSettings);
                }
            }
            const saveSetting = () => {
                settingStorage.setItem('auth_info', { "refresh_token": setting.refresh_token })
                STORE.dispatch({ type: 'SAVE_SETTING', payload: setting })
            }
            return (
                <Modal show={props.show} onHide={props.onHide} onShow={loadSetting}>
                    <Modal.Header closeButton onHide={props.onHide}>
                        <Modal.Title>设置</Modal.Title>
                    </Modal.Header>
                    <Modal.Body>
                        <Form>
                            <ListGroup>
                                {settings.map((value, index) => {
                                    const key = Object.keys(value)[0];
                                    const items = value[key];
                                    return (<ListGroup.Item>
                                        {items.map((setting_item) => {
                                            return (
                                                <Form.Group as={Row} className="mb-3">
                                                    <Form.Label column sm="3">
                                                        {setting_item.label}
                                                    </Form.Label>
                                                    <Col sm="9">
                                                        <Form.Control type={setting_item.show ? "input" : "password"} value={setting[setting_item.key]} name={setting_item.key} placeholder={setting_item.label} onChange={(e) => { setSetting({ ...setting, [setting_item.key]: e.target.value }) }} />
                                                    </Col>
                                                </Form.Group>
                                            )
                                        })}
                                    </ListGroup.Item>)
                                })}
                            </ListGroup>
                        </Form>
                    </Modal.Body>
                    <Modal.Footer className="justify-content-between">
                        <Button
                            variant="secondary"
                            onClick={() => {
                                props.onHide();
                            }}
                        >
                            关闭
                        </Button>
                        <Button
                            variant="primary"
                            onClick={() => {
                                saveSetting();
                                props.onHide();
                            }}
                        >
                            保存
                        </Button>
                    </Modal.Footer>
                </Modal>
            );
        };

        //分页hooks
        const usePagination = () => {
            const [pagination, setPagination] = useState({
                pageSize: 36,
                pageIndex: 1,
            });
            const { pageSize, pageIndex } = pagination;


            return {
                limit: pageSize,
                onPaginationChange: setPagination,
                pagination,
                skip: pageSize * (pageIndex - 1),
            };
        }
        //分页结束

        const paginateLinksGet = async (page_token, keyword) => {
            const url = `/files`;
            const { data } = await axios.post(url,
                {
                    "size": 100,
                    "parent_id": "",
                    "next_page_token": page_token,
                    "additional_filters": {},
                    "additionalProp1": {}
                },
                {
                    headers: {
                        'Authorization': setting.secret_token,
                        'Content-Type': 'application/json'
                    },
                })
            return data
        }

        const paginateFavoritesGet = async (limit, page, keyword) => {
            const url = `/favorites?size=${limit}&page=${page}&kw=${keyword}`;
            const { data } = await axios.get(url)
            return data
        }

        const paginateTagLinksGet = async (limit, page, tag) => {
            const url = `/tags?size=${limit}&page=${page}&tag=${tag}`;
            const { data } = await axios.get(url)
            return data
        }

        const paginateTasksGet = async (limit, skip) => {
            const setting = STORE.getState().settings;
            const url = setting.directus_host + `items/task?limit=${limit}&offset=${skip}&meta[]=filter_count&sort[]=-id`;
            const { data } = await axios.get(url, { headers: { Authorization: "Bearer " + setting.directus_token } })
            return data
        }


        //API定义结束

        const Layout = ({ children }) => {
            const { data: loginData, refetch: loginRefetch, isLoading: loginLoading, error: loginError } = useQuery({
                queryKey: ['get_login_url'],
                queryFn: async () => {
                    var url = '/login';
                    return await axios.get(url)
                },
                enabled: false,
            })

            const { data: logoutData, error: logoutError, mutateAsync: logoutMutation } = useMutation({
                mutationKey: ["create_share"],
                mutationFn: async () => {
                    var url = '/api/user/logoff';
                    return await axios.post(url, { "refresh_token": globalSetting.refresh_token })
                },
                onSuccess: async (data, variables, context) => {
                    hideLoading();
                },
                onError: () => {
                    hideLoading();
                }
            })



            const [showLogin, setShowLogin] = useState(false);
            const globalSetting = STORE.getState().settings;
            useEffect(() => {
                if (!globalSetting.refresh_token || globalSetting.refresh_token.length < 5) {
                    layer.alert("请先正确配置刷新令牌", { icon: 5 });
                    loginRefetch()
                    return
                }
            }, []);

            useEffect(() => {
                if (logoutData) {
                    settingStorage.setItem('auth_info', {})
                    settingStorage.setItem('webdavs', {})
                    settingStorage.setItem('downloads', [])
                    STORE.dispatch({ type: 'RESET_SETTING', payload: {} })
                    window.location.reload()
                }
            }, [logoutData]);

            useEffect(() => {
                if (logoutError) {
                    layer.alert("退出发生错误,请检查Refresh Token是否正确", { icon: 5 });
                }
            }, [logoutError]);

            const [showSideBar, setShowSideBar] = useState(false);
            const handleSidebarClose = () => setShowSideBar(false);
            const handleSidebarShow = () => setShowSideBar(true);
            const toggleSidebarShow = () => {
                setShowSideBar(!showSideBar);
            };
            const [setting, setSetting] = useState(false);

            return (
                <div>
                    <header className="sticky-top">
                        <Navbar expand="md">
                            <Container fluid>
                                <div>
                                    <Navbar.Toggle
                                        className="shadow-none border-0"
                                        onClick={handleSidebarShow}
                                        children={
                                            <Icon
                                                icon="menu"
                                                size="3"
                                                className="text-white"
                                            />
                                        }
                                    />
                                    <Navbar.Brand
                                        as={Link}
                                        to="/"
                                        className="text-white"
                                    >
                                        文件列表
                                    </Navbar.Brand>
                                </div>
                                <div className="d-flex">
                                    <Offline />
                                    <Tasks />
                                    <LocalTasks />


                                    <Button
                                        style={{
                                            backgroundColor: "transparent",
                                        }}
                                        className="nav-link btn"
                                        onClick={() => {
                                            setSetting(true)
                                        }}
                                        children={
                                            <Icon
                                                icon="dots-vertical"
                                                size="3"
                                                className="text-white"
                                            />
                                        }
                                    ></Button>
                                    <SettingModal
                                        show={setting}
                                        onHide={() => {
                                            setSetting(false);
                                        }}
                                    />

                                    <Button
                                        style={{
                                            backgroundColor: "transparent",
                                        }}
                                        className="nav-link btn"
                                        onClick={() => {
                                            if (globalSetting && globalSetting.refresh_token && globalSetting.refresh_token.length > 5) {
                                                layer.confirm('确定退出？该操作无法撤销!!!', { icon: 3 }, function (index) {
                                                    logoutMutation();
                                                    layer.close(index);
                                                }, function () {

                                                });
                                            } else {
                                                layer.alert("Rfresh Token不能为空!!!", { icon: 5 });
                                            }
                                        }}
                                        children={
                                            <Icon
                                                icon="logout"
                                                size="3"
                                                className="text-white"
                                            />
                                        }
                                    ></Button>


                                </div>
                            </Container>
                        </Navbar>
                    </header>
                    <Container fluid>
                        <Row style={{ minHeight: "100vh" }}>
                            <Col
                                md="2"
                                lg="2"
                                xl="2"
                                className="ps-0 d-none d-md-block"
                            >
                                <Offcanvas
                                    className="leftsidebar h-100 bg-light"
                                    show={showSideBar}
                                    onHide={handleSidebarClose}
                                    placement="start"
                                    responsive="md"
                                >
                                    <Offcanvas.Header
                                        className="py-2 border-bottom"
                                        closeButton
                                    >
                                        <Offcanvas.Title>
                                            离线任务
                                        </Offcanvas.Title>
                                    </Offcanvas.Header>
                                    <Offcanvas.Body className="p-0">
                                        <Container fluid className="p-0">
                                            <Nav
                                                activeKey="1"
                                                className="flex-column"
                                            >
                                                <Nav.Link
                                                    as={Link}
                                                    className="nav-link text-dark"
                                                    to="/"
                                                    onClick={
                                                        handleSidebarClose
                                                    }
                                                >
                                                    <Icon
                                                        icon="file"
                                                        size="6"
                                                        className="me-2"
                                                    />
                                                    文件列表
                                                </Nav.Link>
                                                <Nav.Link
                                                    as={Link}
                                                    className="nav-link text-dark"
                                                    to="/trash"
                                                    onClick={
                                                        handleSidebarClose
                                                    }
                                                >
                                                    <Icon
                                                        icon="trash-can-outline"
                                                        size="6"
                                                        className="me-2"
                                                    />
                                                    回收站
                                                </Nav.Link>
                                                <Nav.Link
                                                    as={Link}
                                                    className="nav-link text-dark"
                                                    to="/shares"
                                                    onClick={
                                                        handleSidebarClose
                                                    }
                                                >
                                                    <Icon
                                                        icon="share-variant"
                                                        size="6"
                                                        className="me-2"
                                                    />
                                                    分享列表
                                                </Nav.Link>
                                                <Nav.Link
                                                    as={Link}
                                                    className="nav-link text-dark"
                                                    to="/offlinetask"
                                                    onClick={
                                                        handleSidebarClose
                                                    }
                                                >
                                                    <Icon
                                                        icon="magnet"
                                                        size="6"
                                                        className="me-2"
                                                    />
                                                    离线任务
                                                </Nav.Link>

                                                <Nav.Link
                                                    as={Link}
                                                    className="nav-link text-dark"
                                                    to="/webdav"
                                                    onClick={
                                                        handleSidebarClose
                                                    }
                                                >
                                                    <Icon
                                                        icon="cloud-outline"
                                                        size="6"
                                                        className="me-2"
                                                    />
                                                    WebDav
                                                </Nav.Link>

                                            </Nav>
                                        </Container>
                                    </Offcanvas.Body>
                                </Offcanvas>
                            </Col>

                            <Col xs="12" sm="12" md="10" lg="10" xl="10">
                                <main>
                                    <Container fluid className="pt-2 px-0 pb-5">
                                        {loginData && (
                                            <Alert variant="success">
                                                <Alert.Heading>打开下面网址，获取Refresh Token!</Alert.Heading>
                                                <p>
                                                    <a target="_blank" href={loginData.data.url}>{loginData.data.url}</a>
                                                </p>
                                            </Alert>
                                        )}

                                        {loginError && (
                                            <Alert variant="danger">
                                                <p>
                                                    {JSON.stringify(loginError)}
                                                </p>
                                            </Alert>
                                        )}

                                        {children}
                                    </Container>
                                </main>
                            </Col>
                        </Row>
                    </Container>
                </div>
            );
        };
        const Home = () => {
            const location = useLocation();
            const { id } = useParams();
            return (
                <div>
                    <div className="d-flex justify-content-between align-items-center p-2 border-bottom bg-light">
                        <label className="fs-3">Home</label>
                        <ButtonToolbar
                            aria-label="文件列表"
                            className="bg-teal rounded"
                        >
                            <ButtonGroup className="bg-teal">
                                <IconButton
                                    onClick={() => {
                                        alert("test")
                                    }}
                                    text="刷新"
                                    className="bg-teal border-0"
                                    icon="reload"
                                    iconClassName="me-1 text-white"
                                    iconSize="6"
                                />
                                <IconButton
                                    onClick={() => {
                                        alert("hello");
                                    }}
                                    text="删除"
                                    className="bg-teal border-0"
                                    icon="delete-outline"
                                    iconClassName="me-1 text-white"
                                    iconSize="6"
                                />
                            </ButtonGroup>
                        </ButtonToolbar>
                    </div>
                    <Container fluid className="p-2"></Container>
                </div>
            );
        };

        const Videos = () => {
            const [reload, setReload] = useState(false);
            const [pageToken, setPageToken] = useState('');
            const [limit, setLimit] = useState(20);
            const [keyword, setKeyword] = useState("")
            const [search, setSearch] = useState("")
            const [videos, setVideos] = useState([])
            const [webdav, setWebdav] = useState({})
            const setting = STORE.getState().settings;
            const location = useLocation();
            var path = "/"

            useEffect(() => {
                if (!setting.refresh_token || setting.refresh_token.length < 5) {
                    layer.alert("请先正确配置刷新令牌", { icon: 5 });
                    return
                }
                setVideos([])
                setPageToken("")
                filesMutation()
            }, [location]);




            const [isAllSelected, setIsAllSelected] = useState(false);
            const [selectedVideos, setSelectedVideos] = useState([]);
            const handleCheckboxChange = (event, optionId) => {
                if (event.target.checked) {
                    // 如果被勾选，则将该选项添加到 selectedVideos 中
                    setSelectedVideos(prevState => [...prevState, optionId]);
                } else {
                    // 如果取消勾选，则从 selectedVideos 中移除该选项
                    setSelectedVideos(prevState => prevState.filter(id => id !== optionId));
                }
            };

            useEffect(() => {
                setIsAllSelected(videos.length > 0 && selectedVideos.length === videos.length);
            }, [selectedVideos]);
            const handleSelectAllChange = (event) => {
                if (event.target.checked) {
                    // 全选：将所有选项的 id 添加到 selectedOptions 中
                    setSelectedVideos(videos.map(option => option.identity));
                } else {
                    // 取消全选：清空选中的选项
                    setSelectedVideos([]);
                }
            };


            const columns = [
                {
                    title: (<input
                        type="checkbox"
                        checked={isAllSelected}
                        onChange={handleSelectAllChange}
                    />), dataIndex: "identity", render: (row) => (
                        <input
                            type="checkbox"
                            checked={selectedVideos.includes(row.identity)}
                            onChange={(e) => handleCheckboxChange(e, row.identity)}
                        />
                    )
                },
                { title: "文件名称", dataIndex: "name" },
                { title: "大小", dataIndex: "size", render: (row) => (bytesToSize(Number(row.size))) },
                { title: "日期", dataIndex: "create_ts", render: (row) => (formatDate(row.create_ts)) },
                {
                    title: "操作",
                    dataIndex: "name",
                    render: (row) => (
                        <div className="d-flex justify-content-center">
                            {
                                row.dir ? (<Nav.Link
                                    as={Link}
                                    className="nav-link text-dark"
                                    to={`/videos${row.path}`}
                                    target="_blank"
                                >
                                    <Icon
                                        icon="open-in-new"
                                        size="6"
                                        className="me-2"
                                    />
                                </Nav.Link>) :
                                    (<Icon
                                        icon="download-outline"
                                        size="6"
                                        className="me-2"
                                        onClick={async () => {
                                            if (webdav.username !== undefined && webdav.username !== null) {
                                                row.url = `https://${webdav.username}:${webdav.password}@dav.2dland.cn${path}/${row.name}`
                                                emitEvent("addDownload", row)
                                            } else {
                                                layer.alert("请先设置WebDav信息!!!", { icon: 5 });
                                            }

                                        }}
                                    />)
                            }

                            <Icon
                                icon="delete"
                                size="6"
                                className="me-2"
                                onClick={async () => {
                                    layer.open({
                                        type: 1,
                                        title: '直接删除将不会把文件放到回收站!!!!',
                                        btn: ['回收站', '直接删除'],
                                        yes: async function (index, layero) {
                                            let data = { "ids": [{ identity: row.identity }], url: "/api/file/trash" }
                                            await deleteMutation(data);
                                            layer.close(index);
                                        },
                                        btn2: async function (index, layero) {
                                            let data = { "ids": [{ identity: row.identity }], url: "/api/file/delete" }
                                            await deleteMutation(data);
                                            layer.close(index);
                                        }
                                    });
                                }}
                            />
                            <Icon
                                icon="share-variant"
                                size="6"
                                className="me-2"
                                onClick={async () => {
                                    let data = { "id": row.name }
                                    await sharedMutation(data);
                                }}
                            />
                        </div>
                    ),
                },
            ];
            const authorization = setting.refresh_token;
            const { data: shareData, mutateAsync: sharedMutation } = useMutation({
                mutationKey: ["create_share"],
                mutationFn: async (fileinfo) => {
                    showLoading();
                    var fiel_path = path + '/' + fileinfo.id;
                    var url = '/api/share/create';
                    var data = { "path_list": [fiel_path], "lifetime": -1 }
                    return await axios.post(url, data)
                },
                onSuccess: async (data, variables, context) => {
                    hideLoading();
                },
                onError: () => {
                    hideLoading();
                }
            })
            const { data: deleteData, mutateAsync: deleteMutation } = useMutation({
                mutationKey: ["delete_file"],
                mutationFn: async (fileinfo) => {
                    showLoading();
                    //var fiel_path = path + '/' + fileinfo.id;
                    var data = { source: fileinfo.ids }
                    return await axios.delete(fileinfo.url, {
                        data: data
                    })
                },
                onSuccess: async (data, variables, context) => {
                    hideLoading();
                    forceUpdate();
                },
                onError: () => {
                    hideLoading();
                }
            })
            const { data: linksData, mutateAsync: filesMutation, error: linksError, isPending: linksLoading } = useMutation({
                mutationKey: ["get-files"],
                mutationFn: async () => {
                    showLoading();
                    if (location.pathname.startsWith("/videos/")) {
                        path = location.pathname.slice(7)
                    } else {
                        path = "/"
                    }
                    let data = {
                        "parent": {
                            "path": path
                        },
                        "filter": {},
                        "list_info": {
                            "limit": limit,
                            "token": pageToken
                        }
                    };
                    var url = '/api/file/list';
                    return await axios.post(url, data)
                },
                onSuccess: async (data, variables, context) => {
                    hideLoading();
                },
                onError: () => {
                    hideLoading();
                }
            })


            useEffect(() => {
                settingStorage.getItem('webdavs').then(function (value) {
                    if (value && value.length > 0) {
                        setWebdav(value[0])
                    }
                }).catch(function (err) {
                    console.log(err)
                });
            }, []);


            useEffect(() => {
                if (linksData) {
                    if (linksData.data.result.list_info.token) {
                        setPageToken(linksData.data.result.list_info.token)
                    } else {
                        setPageToken("")
                    }
                    if (linksData.data.result.hasOwnProperty('files')) {
                        setVideos([...videos, ...linksData.data.result.files])
                    }
                }
            }, [linksData]);


            useEffect(() => {
                if (deleteData) {
                    layer.msg("删除完成，请刷新查看结果");
                    setPageToken("")
                    setVideos([])
                    filesMutation()
                }
            }, [deleteData]);

            useEffect(() => {
                if (shareData) {
                    layer.alert(shareData.data.result.identity);
                }
            }, [shareData]);

            const handleSearchClick = () => {
                setSearch(keyword)
            };


            const forceUpdate = () => {
                setReload((pre) => !pre);
            };



            return (
                <div>
                    <div className="d-flex justify-content-between align-items-center p-2 border-bottom bg-light">
                        <label className="fs-3">文件列表</label>
                        <ButtonToolbar
                            aria-label="文件列表"
                            className="bg-teal rounded"
                        >
                            <ButtonGroup className="bg-teal">
                                <IconButton
                                    onClick={async () => {
                                        if (selectedVideos.length > 0) {
                                            layer.open({
                                                type: 1,
                                                title: '直接删除将不会把文件放到回收站!!!!',
                                                btn: ['回收站', '直接删除'],
                                                yes: async function (index, layero) {
                                                    const files = selectedVideos.map(value => {
                                                        return {
                                                            identity: value,
                                                        };
                                                    });
                                                    let data = { "ids": files, url: "/api/file/trash" }
                                                    await deleteMutation(data);
                                                    layer.close(index);
                                                },
                                                btn2: async function (index, layero) {
                                                    const files = selectedVideos.map(value => {
                                                        return {
                                                            identity: value,
                                                        };
                                                    });
                                                    let data = { "ids": files, url: "/api/file/delete" }
                                                    await deleteMutation(data);
                                                    layer.close(index);
                                                }
                                            });
                                        } else {
                                            layer.alert("请选择要删除的数据", { icon: 5 });
                                        }

                                    }}
                                    text="删除所选"
                                    className="bg-teal border-0"
                                    icon="delete-outline"
                                    iconClassName="me-1 text-white"
                                    iconSize="6"
                                />
                                <IconButton
                                    onClick={() => {
                                        fetchData();
                                    }}
                                    text="刷新"
                                    className="bg-teal border-0"
                                    icon="reload"
                                    iconClassName="me-1 text-white"
                                    iconSize="6"
                                />
                            </ButtonGroup>
                        </ButtonToolbar>
                    </div>
                    {linksError && (
                        <div className="text-center text-danger">
                            发生错误，请稍后重试！！！
                        </div>
                    )}

                    <Container fluid className="p-2">
                        <InputGroup className="mb-3">
                            <Form.Control
                                placeholder="关键词"
                                aria-label="关键词"
                                aria-describedby="关键词"
                                onChange={e => setKeyword(e.target.value)}
                            />
                            <Button variant="outline-secondary" id="button-addon2" onClick={() => { handleSearchClick() }}>
                                搜索
                            </Button>
                        </InputGroup>

                        {(linksLoading) && (
                            <Row>
                                <Col xs={12} className="py-2">
                                    <div className="text-center text-success">
                                        正在努力加载中......
                                    </div>
                                </Col>
                            </Row>
                        )}
                        {linksData && (
                            <Row>
                                <DataTable data={videos ? videos : []} columns={columns} />
                            </Row>
                        )}

                        {pageToken.length > 5 && (
                            <Row>
                                <Col xs={12} className="py-2">
                                    <Button variant="primary" onClick={() => { filesMutation() }}>更多</Button>
                                </Col>
                            </Row>
                        )}

                    </Container>
                </div>
            );
        };


        const Trash = () => {
            const [reload, setReload] = useState(false);
            const [pageToken, setPageToken] = useState('');
            const [limit, setLimit] = useState(20);
            const [keyword, setKeyword] = useState("")
            const [search, setSearch] = useState("")
            const [videos, setVideos] = useState([])
            const setting = STORE.getState().settings;

            var path = location.hash.replace('#/videos', '').replace(/^\/+/, '') || '';
            if (path === '#/') {
                path = ''; // 处理为根目录，即 /videos 下的内容
            }

            const columns = [
                { title: "文件名称", dataIndex: "name" },
                { title: "大小", dataIndex: "size", render: (row) => (bytesToSize(Number(row.size))) },
                { title: "日期", dataIndex: "create_ts", render: (row) => (formatDate(row.create_ts)) },
                {
                    title: "操作",
                    dataIndex: "name",
                    render: (row) => (
                        <div className="d-flex justify-content-center">

                            <Icon
                                icon="redo"
                                size="6"
                                className="me-2"
                                onClick={async () => {
                                    let data = { "source": [{ "identity": row.identity }], "dest": { "path": "/" } }
                                    await recoverMutation(data);
                                }}
                            />

                            <Icon
                                icon="delete"
                                size="6"
                                className="me-2"
                                onClick={async () => {
                                    let data = { "id": row.path }
                                    await deleteMutation(data);
                                }}
                            />
                        </div>
                    ),
                },
            ];
            const authorization = setting.refresh_token;

            const { data: recoverData, mutateAsync: recoverMutation } = useMutation({
                mutationKey: ["recover_file"],
                mutationFn: async (fileinfo) => {
                    showLoading();
                    var url = '/api/file/recover';
                    return await axios.post(url, fileinfo)
                },
                onSuccess: async (data, variables, context) => {
                    hideLoading();
                },
                onError: () => {
                    hideLoading();
                }
            })
            const { data: deleteData, mutateAsync: deleteMutation } = useMutation({
                mutationKey: ["delete_file"],
                mutationFn: async (fileinfo) => {
                    showLoading();
                    var url = '/api/file/deletetrash';
                    var data = { source: [{ path: fileinfo.id }] }
                    return await axios.delete(url, {
                        data: data
                    })
                },
                onSuccess: async (data, variables, context) => {
                    hideLoading();
                    forceUpdate();
                },
                onError: () => {
                    hideLoading();
                }
            })
            const { data: linksData, mutateAsync: filesMutation, error: linksError, isPending: linksLoading } = useMutation({
                mutationKey: ["get-trash-files"],
                mutationFn: async (data) => {
                    showLoading();
                    var url = '/api/file/listtrash';
                    return await axios.post(url, data)
                },
                onSuccess: async (data, variables, context) => {
                    hideLoading();
                },
                onError: () => {
                    hideLoading();
                }
            })

            const fetchData = () => {
                if (!setting.refresh_token || setting.refresh_token.length < 5) {
                    layer.alert("请先正确配置刷新令牌", { icon: 5 });
                    return
                }
                let data = {
                    "filter": {},
                    "list_info": {
                        "limit": limit,
                        "token": pageToken
                    }
                };
                filesMutation(data);
            }

            useEffect(() => {
                fetchData()
            }, []);


            useEffect(() => {
                if (linksData) {
                    if (linksData.data.result.list_info.token) {
                        setPageToken(linksData.data.result.list_info.token)
                    } else {
                        setPageToken("")
                    }
                    if (linksData.data.result.hasOwnProperty('files')) {
                        setVideos([...videos, ...linksData.data.result.files])
                    }
                }
            }, [linksData]);


            useEffect(() => {
                if (deleteData) {
                    layer.msg("删除完成，请刷新查看结果");
                    setPageToken("")
                    setVideos([])
                    fetchData()
                }
            }, [deleteData]);

            useEffect(() => {
                if (recoverData) {
                    layer.msg("操作完成，请刷新查看结果");
                    setPageToken("")
                    setVideos([]);
                    fetchData()
                }
            }, [recoverData]);

            const handleSearchClick = () => {
                setSearch(keyword)
            };

            const forceUpdate = () => {
                setReload((pre) => !pre);
            };

            return (
                <div>
                    <div className="d-flex justify-content-between align-items-center p-2 border-bottom bg-light">
                        <label className="fs-3">回收站文件列表</label>
                        <ButtonToolbar
                            aria-label="回收站文件列表"
                            className="bg-teal rounded"
                        >
                            <ButtonGroup className="bg-teal">
                                <IconButton
                                    onClick={async () => {
                                        layer.confirm('确定删除？该操作无法撤销!!!', { icon: 3 }, async function (index) {
                                            let data = { "id": "/" }
                                            await deleteMutation(data);
                                            layer.close(index);
                                        }, function () {

                                        });
                                    }}
                                    text="清空回收站"
                                    className="bg-teal border-0"
                                    icon="delete-empty-outline"
                                    iconClassName="me-1 text-white"
                                    iconSize="6"
                                />
                                <IconButton
                                    onClick={() => {
                                        fetchData();
                                    }}
                                    text="刷新"
                                    className="bg-teal border-0"
                                    icon="reload"
                                    iconClassName="me-1 text-white"
                                    iconSize="6"
                                />
                            </ButtonGroup>
                        </ButtonToolbar>
                    </div>
                    {linksError && (
                        <div className="text-center text-danger">
                            发生错误，请稍后重试！！！
                        </div>
                    )}

                    <Container fluid className="p-2">
                        <InputGroup className="mb-3">
                            <Form.Control
                                placeholder="关键词"
                                aria-label="关键词"
                                aria-describedby="关键词"
                                onChange={e => setKeyword(e.target.value)}
                            />
                            <Button variant="outline-secondary" id="button-addon2" onClick={() => { handleSearchClick() }}>
                                搜索
                            </Button>
                        </InputGroup>

                        {(linksLoading) && (
                            <Row>
                                <Col xs={12} className="py-2">
                                    <div className="text-center text-success">
                                        正在努力加载中......
                                    </div>
                                </Col>
                            </Row>
                        )}
                        {linksData && (
                            <Row>
                                <DataTable data={videos ? videos : []} columns={columns} />
                            </Row>
                        )}

                        {pageToken.length > 5 && (
                            <Row>
                                <Col xs={12} className="py-2">
                                    <Button variant="primary" onClick={() => { fetchData() }}>更多</Button>
                                </Col>
                            </Row>
                        )}

                    </Container>
                </div>
            );
        };

        const Shares = () => {
            const [reload, setReload] = useState(false);
            const [pageToken, setPageToken] = useState('');
            const isFirstRender = useRef(true);
            const [limit, setLimit] = useState(20);
            const [keyword, setKeyword] = useState("")
            const [search, setSearch] = useState("")
            const [videos, setVideos] = useState([])
            const setting = STORE.getState().settings;
            const columns = [
                { title: "文件名称", dataIndex: "name" },
                { title: "分享ID", dataIndex: "identity" },
                { title: "到期时间", dataIndex: "expire_ts", render: (row) => (formatDate(row.expire_ts)) },
                {
                    title: "操作",
                    dataIndex: "name",
                    render: (row) => (
                        <Icon
                            icon="cancel"
                            size="6"
                            className="me-2"
                            onClick={async () => {
                                let data = { "id": row.identity }
                                await deleteMutation(data);
                            }}
                        />
                    ),
                },
            ];
            const authorization = setting.refresh_token;
            const { data: deleteShareData, mutateAsync: deleteMutation } = useMutation({
                mutationKey: ["share_batch_delete"],
                mutationFn: async (fileinfo) => {
                    showLoading();
                    var url = '/api/share/delete';
                    var data = { identity: [fileinfo.id] }
                    return await axios.delete(url, {
                        data: data,
                    })
                },
                onSuccess: async (data, variables, context) => {
                    hideLoading();
                },
                onError: () => {
                    hideLoading();
                }
            })
            const { data: linksData, mutateAsync: filesMutation, error: linksError, isPending: linksLoading } = useMutation({
                mutationKey: ["get_share_list", pageToken],
                mutationFn: async (query) => {
                    showLoading();
                    var url = '/api/share/list';
                    return await axios.post(url, query)
                },
                onSuccess: async (data, variables, context) => {
                    hideLoading();
                },
                onError: () => {
                    hideLoading();
                }
            })


            const fetchData = () => {
                if (!setting.refresh_token || setting.refresh_token.length < 5) {
                    layer.alert("请先正确配置刷新令牌", { icon: 5 });
                    return
                }
                let data = {
                    "list_info": { "limit": limit, "token": pageToken },
                }
                filesMutation(data);
            }


            useEffect(() => {
                fetchData()
            }, []);


            useEffect(() => {
                if (linksData) {
                    if (linksData.data.result.list_info.token) {
                        setPageToken(linksData.data.result.list_info.token)
                    } else {
                        setPageToken("")
                    }
                    if (linksData.data.result.hasOwnProperty('shares')) {
                        setVideos([...videos, ...linksData.data.result.shares])
                    }
                }
            }, [linksData]);

            useEffect(() => {
                if (deleteShareData) {
                    layer.msg("刷新完成，刷新查看");
                    setVideos([])
                    let data = {
                        "list_info": { "limit": limit, "token": "" },
                    }
                    filesMutation(data);
                }
            }, [deleteShareData]);



            return (
                <div>
                    <div className="d-flex justify-content-between align-items-center p-2 border-bottom bg-light">
                        <label className="fs-3">分享列表</label>
                        <ButtonToolbar
                            aria-label="分享列表"
                            className="bg-teal rounded"
                        >
                            <ButtonGroup className="bg-teal">
                                <IconButton
                                    onClick={() => {
                                        fetchData();
                                    }}
                                    text="刷新"
                                    className="bg-teal border-0"
                                    icon="reload"
                                    iconClassName="me-1 text-white"
                                    iconSize="6"
                                />
                            </ButtonGroup>
                        </ButtonToolbar>
                    </div>
                    {linksError && (
                        <div className="text-center text-danger">
                            发生错误，请稍后重试！！！
                        </div>
                    )}

                    <Container fluid className="p-2">
                        {(linksLoading) && (
                            <Row>
                                <Col xs={12} className="py-2">
                                    <div className="text-center text-success">
                                        正在努力加载中......
                                    </div>
                                </Col>
                            </Row>
                        )}
                        {linksData && (
                            <Row>
                                <DataTable data={videos ? videos : []} columns={columns} />
                            </Row>
                        )}
                        {pageToken.length > 5 && (
                            <Row>
                                <Col xs={12} className="py-2">
                                    <Button variant="primary" onClick={() => { fetchData() }}>更多</Button>
                                </Col>
                            </Row>
                        )}

                    </Container>
                </div>
            );
        };

        const OfflineTask = () => {
            const [reload, setReload] = useState(false);
            const [isAllSelected, setIsAllSelected] = useState(false);
            const [pageToken, setPageToken] = useState('');
            const [limit, setLimit] = useState(20);
            const [keyword, setKeyword] = useState("")
            const [search, setSearch] = useState("")
            const [videos, setVideos] = useState([])
            const [selectedTasks, setSelectedTasks] = useState([]);
            const setting = STORE.getState().settings;
            const statusToString = {
                10: "等待下载",
                100: "下载中",
                110: "下载中",
                1000: "下载完成",
            };
            // 处理全选复选框
            const handleSelectAllChange = (event) => {
                if (event.target.checked) {
                    // 全选：将所有选项的 id 添加到 selectedOptions 中
                    setSelectedTasks(videos.map(option => option.identity));
                } else {
                    // 取消全选：清空选中的选项
                    setSelectedTasks([]);
                }
            };

            const columns = [
                {
                    title: (<input
                        type="checkbox"
                        checked={isAllSelected}
                        onChange={handleSelectAllChange}
                    />), dataIndex: "identity", render: (row) => (
                        <input
                            type="checkbox"
                            checked={selectedTasks.includes(row.identity)}
                            onChange={(e) => handleCheckboxChange(e, row.identity)}
                        />
                    )
                },
                { title: "文件名称", dataIndex: "name" },
                { title: "状态", dataIndex: "status", render: (row) => (row.progress ? statusToString[row.status] + '进度:' + row.progress : statusToString[row.status]) },
                { title: "创建时间", dataIndex: "create_ts", render: (row) => (formatDate(row.create_ts)) },
                { title: "保存路径", dataIndex: "save_path", render: (row) => (row.save_path) },
                {
                    title: "操作",
                    dataIndex: "name",
                    render: (row) => (
                        <Icon
                            icon="cancel"
                            size="6"
                            className="me-2"
                            onClick={async () => {
                                let data = { "ids": [row.identity] }
                                await deleteMutation(data);
                            }}
                        />
                    ),
                },
            ];
            const authorization = setting.refresh_token;
            const { data: deleteShareData, mutateAsync: deleteMutation } = useMutation({
                mutationKey: ["share_batch_delete"],
                mutationFn: async (fileinfo) => {
                    showLoading();
                    var url = '/api/offline/delete';
                    var data = { identity: fileinfo.ids }
                    return await axios.delete(url, {
                        data: data,
                    })
                },
                onSuccess: async (data, variables, context) => {
                    hideLoading();
                    forceUpdate();
                },
                onError: () => {
                    hideLoading();
                }
            })
            const { data: offlneTaskData, mutateAsync: offlineTaskMutation, error: offlineTaskError, isPending: offlineTaskLoading } = useMutation({
                mutationKey: ["get_offflinetask_list", pageToken],
                mutationFn: async (query) => {
                    showLoading();
                    let data = {
                        "list_info": { "limit": limit, "token": pageToken },
                    }
                    var url = '/api/offline/list';
                    return await axios.post(url, data)
                },
                onSuccess: async (data, variables, context) => {
                    hideLoading();
                },
                onError: () => {
                    hideLoading();
                }
            })

            const fetchData = () => {
                if (!setting.refresh_token || setting.refresh_token.length < 5) {
                    layer.alert("请先正确配置刷新令牌", { icon: 5 });
                    return
                }
                offlineTaskMutation({});
            }

            // 处理勾选或取消勾选
            const handleCheckboxChange = (event, optionId) => {
                if (event.target.checked) {
                    // 如果被勾选，则将该选项添加到 selectedTasks 中
                    setSelectedTasks(prevState => [...prevState, optionId]);
                } else {
                    // 如果取消勾选，则从 selectedTasks 中移除该选项
                    setSelectedTasks(prevState => prevState.filter(id => id !== optionId));
                }
            };

            useEffect(() => {
                fetchData()
            }, []);

            useEffect(() => {
                setIsAllSelected(videos.length > 0 && selectedTasks.length === videos.length);
            }, [selectedTasks]);


            useEffect(() => {
                if (offlneTaskData) {
                    if (offlneTaskData.data.result.list_info.token) {
                        setPageToken(offlneTaskData.data.result.list_info.token)
                    } else {
                        setPageToken("")
                    }
                    if (offlneTaskData.data.result.hasOwnProperty('tasks')) {
                        setVideos([...videos, ...offlneTaskData.data.result.tasks])
                    }

                }
            }, [offlneTaskData]);

            useEffect(() => {
                if (deleteShareData) {
                    layer.msg("刷新完成，刷新查看");
                    setVideos([])
                    setPageToken("")
                    fetchData()
                }
            }, [deleteShareData]);

            const forceUpdate = () => {
                setReload((pre) => !pre);
            };

            return (
                <div>
                    <div className="d-flex justify-content-between align-items-center p-2 border-bottom bg-light">
                        <label className="fs-3">离线任务列表</label>
                        <ButtonToolbar
                            aria-label="离线任务列表"
                            className="bg-teal rounded"
                        >
                            <ButtonGroup className="bg-teal">
                                <IconButton
                                    onClick={async () => {
                                        if (selectedTasks.length > 0) {
                                            let data = { "ids": selectedTasks }
                                            await deleteMutation(data);
                                        } else {
                                            layer.alert("请选择要删除的数据", { icon: 5 });
                                        }
                                    }}
                                    text="清理记录"
                                    className="bg-teal border-0"
                                    icon="delete-outline"
                                    iconClassName="me-1 text-white"
                                    iconSize="6"
                                />
                                <IconButton
                                    onClick={() => {
                                        fetchData();
                                    }}
                                    text="刷新"
                                    className="bg-teal border-0"
                                    icon="reload"
                                    iconClassName="me-1 text-white"
                                    iconSize="6"
                                />
                            </ButtonGroup>
                        </ButtonToolbar>
                    </div>
                    {offlineTaskError && (
                        <div className="text-center text-danger">
                            发生错误，请稍后重试！！！
                        </div>
                    )}

                    <Container fluid className="p-2">
                        {(offlineTaskLoading) && (
                            <Row>
                                <Col xs={12} className="py-2">
                                    <div className="text-center text-success">
                                        正在努力加载中......
                                    </div>
                                </Col>
                            </Row>
                        )}
                        {offlneTaskData && (
                            <Row>
                                <DataTable data={videos ? videos : []} columns={columns} />
                            </Row>
                        )}

                        {pageToken.length > 5 && (
                            <Row>
                                <Col xs={12} className="py-2">
                                    <Button variant="primary" onClick={() => { fetchData() }}>更多</Button>
                                </Col>
                            </Row>
                        )}


                    </Container>
                </div>
            );
        };


        const WebDav = () => {
            const authorization = STORE.getState().settings.refresh_token;
            const { data: webdavData, mutateAsync: webdavMutation, error: webdavError, isPending: webdavLoading } = useMutation({
                mutationKey: ["get_webdav"],
                mutationFn: async (query) => {
                    showLoading();
                    var url = '/api/webdav/listall';
                    return await axios.post(url, query)
                },
                onSuccess: async (data, variables, context) => {
                    hideLoading();
                },
                onError: () => {
                    hideLoading();
                }
            })
            const columns = [
                {
                    title: "用户名",
                    dataIndex: "username",
                    render: (row) => (
                        <p>
                            {row.username} <Button
                                data-clipboard-text={row.username}
                                className="bg-teal border-0 btn-sm copybtn">
                                <Icon
                                    icon="content-copy"
                                    size="6"
                                />
                            </Button>
                        </p>
                    ),

                },
                {
                    title: "密码", dataIndex: "password", render: (row) => (
                        <p>
                            {row.password} <Button
                                data-clipboard-text={row.password}
                                className="bg-teal border-0 btn-sm copybtn">
                                <Icon
                                    icon="content-copy"
                                    size="6"
                                />
                            </Button>
                        </p>
                    ),
                },
                { title: "目录", dataIndex: "root" },
                {
                    title: "操作", dataIndex: "user_identity", render: (row) => (
                        <IconButton
                            onClick={() => {
                                deleteWebdavMutation({ user_identity: row.user_identity, username: row.username, password: row.password });
                            }}
                            className="bg-teal border-0"
                            icon="delete"
                            iconClassName="text-white"
                            iconSize="6"
                        />
                    )
                },
            ];
            const [webdavs, setWebdavs] = useState([])
            useEffect(() => {
                settingStorage.setItem('webdavs', webdavs)
            }, [webdavs]);

            useEffect(() => {
                settingStorage.getItem('webdavs').then(function (value) {
                    if (value) {
                        setWebdavs(value)
                    }
                }).catch(function (err) {
                    console.log(err)
                });
                webdavMutation({})
            }, []);

            useEffect(() => {
                if (webdavData) {
                    if (webdavData.data.result.hasOwnProperty('configs')) {
                        setWebdavs([...webdavData.data.result.configs])
                    }
                }
            }, [webdavData]);


            const { data: addWebdavData, mutateAsync: addWebdavMutation, error: addWebdavError, isPending: addWebdavLoading } = useMutation({
                mutationKey: ["create_webdav"],
                mutationFn: async (query) => {
                    showLoading();
                    var url = '/api/webdav/create';
                    return await axios.post(url, query)
                },
                onSuccess: async (data, variables, context) => {
                    hideLoading();
                },
                onError: () => {
                    hideLoading();
                }
            })

            const { data: deleteWebdavData, mutateAsync: deleteWebdavMutation, error: deleteWebdavError, isPending: deleteWebdavLoading } = useMutation({
                mutationKey: ["create_webdav"],
                mutationFn: async (query) => {
                    showLoading();
                    var url = '/api/webdav/delete';
                    return await axios.delete(url, {
                        data: query
                    })
                },
                onSuccess: async (data, variables, context) => {
                    hideLoading();
                },
                onError: () => {
                    hideLoading();
                }
            })




            const [show, setShow] = useState(false);
            const [webdav, setWebdav] = useState({});
            const handleClose = () => {
                setWebdav({});
                setShow(false)
            };
            const handleShow = () => setShow(true);
            const onSave = () => {
                var data = { username: webdav.username, password: webdav.password, root: webdav.root, enable_flag: 1 }
                addWebdavMutation(data)
            }

            useEffect(() => {
                if (addWebdavData) {
                    if (addWebdavData.data.result.hasOwnProperty('user_identity')) {
                        handleClose()
                        webdavMutation({})
                    }
                }
            }, [addWebdavData]);

            useEffect(() => {
                if (deleteWebdavData) {
                    if (deleteWebdavData.data.result.hasOwnProperty('user_identity')) {
                        webdavMutation({})
                    }
                }
            }, [deleteWebdavData]);

            return (
                <div>
                    <div className="d-flex justify-content-between align-items-center p-2 border-bottom bg-light">
                        <label className="fs-3">WebDav设置</label>
                        <ButtonToolbar
                            aria-label="WebDav设置"
                            className="bg-teal rounded"
                        >
                            <ButtonGroup className="bg-teal">
                                <IconButton
                                    onClick={handleShow}
                                    text="新建用户"
                                    className="bg-teal border-0"
                                    icon="plus"
                                    iconClassName="me-1 text-white"
                                    iconSize="6"
                                />
                                <Modal show={show} onHide={handleClose}>
                                    <Modal.Header closeButton>
                                        <Modal.Title>创建新用户</Modal.Title>
                                    </Modal.Header>
                                    <Modal.Body>
                                        <Form>
                                            <Form.Group as={Row} className="mb-3" controlId="formPlaintextEmail">
                                                <Form.Label column sm="2">
                                                    用户名:
                                                </Form.Label>
                                                <Col sm="10">
                                                    <Form.Control type="text" defaultValue="" onChange={(e) => { setWebdav({ ...webdav, username: e.target.value }) }} />
                                                </Col>
                                            </Form.Group>

                                            <Form.Group as={Row} className="mb-3" controlId="formPlaintextPassword">
                                                <Form.Label column sm="2">
                                                    密码:
                                                </Form.Label>
                                                <Col sm="10">
                                                    <Form.Control type="text" defaultValue="" onChange={(e) => { setWebdav({ ...webdav, password: e.target.value }) }} />
                                                </Col>
                                            </Form.Group>

                                            <Form.Group as={Row} className="mb-3" controlId="formPlaintextPassword">
                                                <Form.Label column sm="2">
                                                    目录:
                                                </Form.Label>
                                                <Col sm="10">
                                                    <Form.Control type="text" defaultValue="" onChange={(e) => { setWebdav({ ...webdav, root: e.target.value }) }} />
                                                </Col>
                                            </Form.Group>

                                        </Form>
                                    </Modal.Body>
                                    <Modal.Footer>
                                        <Button variant="secondary" onClick={handleClose}>
                                            取消
                                        </Button>
                                        <Button variant="primary" onClick={onSave}>
                                            保存
                                        </Button>
                                    </Modal.Footer>
                                </Modal>
                            </ButtonGroup>
                        </ButtonToolbar>

                    </div>
                    <Alert variant="info">
                        WebDAV是一种通过HTTP协议进行文件管理的协议。它允许用户在Web服务器上创建、编辑、删除和管理文件，受到许多媒体播放器支持
                    </Alert>
                    <Container fluid className="p-2">
                        <Form>
                            <Form.Group className="mb-3" controlId="formBasicEmail">
                                <Form.Label>服务器地址</Form.Label>
                                <InputGroup className="mb-3">
                                    <Form.Control placeholder="https://dav.2dland.cn" id="davaddress" value="https://dav.2dland.cn" readOnly />

                                    <Button
                                        data-clipboard-target="#davaddress"
                                        className="bg-teal border-0 copybtn">
                                        <Icon
                                            icon="content-copy"
                                            size="6"
                                            className="me-2"
                                        />
                                    </Button>
                                </InputGroup>
                            </Form.Group>

                            <Form.Group className="mb-3" controlId="formBasicEmail">
                                <Form.Label>服务器端口</Form.Label>
                                <InputGroup className="mb-3">
                                    <Form.Control placeholder="443" id="davport" value="443" readOnly />
                                    <Button
                                        data-clipboard-target="#davport"
                                        className="bg-teal border-0 copybtn">
                                        <Icon
                                            icon="content-copy"
                                            size="6"
                                            className="me-2"
                                        />
                                    </Button>
                                </InputGroup>
                            </Form.Group>


                        </Form>

                        {webdavError && (
                            <div className="text-center text-danger">
                                发生错误，请稍后重试！！！
                            </div>
                        )}

                        {webdavLoading && (
                            <div className="text-center text-success">
                                正在努力加载中...
                            </div>
                        )}

                        {webdavs && (
                            <Row>
                                <DataTable data={webdavs ? webdavs : []} columns={columns} />
                            </Row>
                        )}


                    </Container>
                </div>
            )
        }

        const Offline = () => {
            const [selectedOption, setSelectedOption] = useState(1);
            const handleOptionChange = (event) => {
                setSelectedOption(event.target.value);
            };

            const [linkValue, setLinkValue] = useState('');
            const handleLinkChange = (event) => {
                setLinkValue(event.target.value);
            };

            const [show, setShow] = useState(false);
            const handleClose = () => setShow(false);
            const handleShow = () => setShow(true);
            const setting = STORE.getState().settings;
            const authorization = setting.refresh_token;

            const { data: taskData, mutateAsync: offlineMutation, error: taskError, isPending: taskLoading } = useMutation({
                mutationKey: ["offfline-files"],
                mutationFn: async (query) => {
                    showLoading();
                    var url = query.url;
                    return await axios.post(url, query.data)
                },
                onSuccess: async (data, variables, context) => {
                    hideLoading();
                },
                onError: () => {
                    hideLoading();
                }
            })

            useEffect(() => {
                if (taskData) {
                    layer.msg("添加完成，刷新查看");
                }
            }, [taskData]);


            return (
                <div>
                    <Button
                        style={{
                            backgroundColor: "transparent",
                        }}
                        className="nav-link btn mr-1"
                        onClick={handleShow}
                        children={
                            <span>
                                <Icon
                                    icon="plus"
                                    size="3"
                                    className="text-white"
                                />
                            </span>
                        }
                    ></Button>
                    <Modal show={show} onHide={handleClose}>
                        <Modal.Header closeButton>
                            <Modal.Title>添加离线</Modal.Title>
                        </Modal.Header>
                        <Modal.Body>
                            <Form>
                                <Form.Group className="mb-3" controlId="exampleForm.ControlInput1">
                                    <Form.Label>链接类型</Form.Label>
                                    <div>
                                        <Form.Check
                                            inline
                                            label="磁力"
                                            name="offline_type"
                                            type="radio"
                                            value={1}
                                            checked={selectedOption == 1}
                                            onChange={handleOptionChange}
                                        />
                                        <Form.Check
                                            inline
                                            label="分享"
                                            name="offline_type"
                                            type="radio"
                                            value={2}
                                            checked={selectedOption == 2}
                                            onChange={handleOptionChange}
                                        />
                                    </div>
                                </Form.Group>
                                <Form.Group
                                    className="mb-3"
                                    controlId="exampleForm.ControlTextarea1"
                                >
                                    <Form.Label>链接地址</Form.Label>
                                    <Form.Control as="textarea" value={linkValue}
                                        onChange={handleLinkChange} rows={3} />
                                </Form.Group>
                            </Form>
                        </Modal.Body>
                        <Modal.Footer>
                            <Button variant="secondary" onClick={handleClose}>
                                关闭
                            </Button>
                            <Button variant="primary" onClick={async () => {
                                var data = {};
                                if (selectedOption == 1) {
                                    data = {
                                        url: "/api/offline/add",
                                        data: {
                                            "url": linkValue,
                                            "save_path": "/",
                                        }
                                    }
                                } else {
                                    data = {
                                        url: "/api/share/save",
                                        data: {
                                            "identity": linkValue,
                                            "save_path": "/",
                                            "password": "",
                                        }
                                    }
                                }
                                await offlineMutation(data);
                            }}>
                                保存
                            </Button>
                        </Modal.Footer>
                    </Modal>
                </div>
            );
        }
        const Tasks = () => {
            const [show, setShow] = useState(false);
            const handleClose = () => setShow(false);
            const handleShow = () => setShow(true);
            const [reload, setReload] = useState(false);
            const { limit, onPaginationChange, skip, pagination } = usePagination();
            const [meta, setMeta] = useState({ filter_count: 0 })
            const [tasks, setTasks] = useState([])
            const { data: tasksData, refetch: tasksRefetch, isLoading: tasksLoading, error: tasksError } = useQuery({
                queryKey: ['get_paginate_tasks', limit, skip],
                queryFn: () => paginateTasksGet(limit, skip),
                enabled: show,
            })

            useEffect(() => {
                //tasksRefetch()
            }, [pagination, reload]);

            useEffect(() => {
                if (tasksData) {
                    setMeta(tasksData.meta)
                    setTasks([...tasksData.data])
                }
            }, [tasksData]);


            const forceUpdate = () => {
                setReload((pre) => !pre);
            };

            return (
                <div>
                    <Button
                        style={{
                            backgroundColor: "transparent",
                        }}
                        className="nav-link btn"
                        onClick={handleShow}
                        children={
                            <span>
                                <Icon
                                    icon="cloud-download-outline"
                                    size="3"
                                    className="text-white"
                                />
                            </span>
                        }
                    ></Button>


                    <Modal show={show} onHide={handleClose}>
                        <Modal.Header closeButton>
                            <Modal.Title>远程下载任务</Modal.Title>
                        </Modal.Header>
                        <Modal.Body className="py-0">
                            {tasksError && (
                                <div className="text-center text-danger">
                                    发生错误，请稍后重试！！！
                                </div>
                            )}
                            {(tasksLoading) && (
                                <div className="text-center text-success">
                                    正在努力加载中......
                                </div>
                            )}
                            <Container fluid className="p-2">
                                <Row>
                                    <Col xs={12}>
                                        <Paginate page={pagination.pageIndex} onClick={(i) => { onPaginationChange({ pageSize: 36, pageIndex: i }) }} itemsPerPage="36" totalCount={meta.filter_count} />
                                    </Col>
                                </Row>

                                <Row>
                                    <Col xs={12}>
                                        <Table bordered hover>
                                            <thead>
                                                <tr>
                                                    <th>#</th>
                                                    <th>文件名</th>
                                                    <th>状态</th>
                                                </tr>
                                            </thead>
                                            {tasksData && (
                                                <tbody>
                                                    {tasks.map((task, index) => (
                                                        <tr>
                                                            <td>{task.id}</td>
                                                            <td>{task.url.substr(task.url.indexOf('##') + 2)}</td>
                                                            <td>{task.status == 'draft' ? <span className="text-warning">待下载</span> : <span class="text-success">正在下载中</span>}</td>
                                                        </tr>
                                                    ))}
                                                </tbody>
                                            )}

                                        </Table>

                                    </Col>
                                </Row>

                                <Row>
                                    <Col xs={12} className="py-2">
                                        <Paginate page={pagination.pageIndex} onClick={(i) => { onPaginationChange({ pageSize: 36, pageIndex: i }) }} itemsPerPage="36" totalCount={meta.filter_count} />
                                    </Col>
                                </Row>
                            </Container>
                        </Modal.Body>
                        <Modal.Footer className="justify-content-between">
                            <Button variant="primary" onClick={() => { forceUpdate(); }}>
                                刷新
                            </Button>
                            <Button variant="primary" onClick={() => {
                                const setting = STORE.getState().settings;
                                showLoading();
                                axios.post(setting.github_host, { "ref": "main", "inputs": {} }, {
                                    headers: {
                                        'Authorization': "Bearer " + setting.github_token,
                                        'Accept': 'application/vnd.github+json',
                                        'X-GitHub-Api-Version': '2022-11-28',
                                    },
                                }).then(function (response) {
                                    layer.msg('任务启动成功', { time: 2000, icon: 6 });
                                    //console.log(response);
                                })
                                    .catch(function (error) {
                                        console.log(error);
                                    }).finally(() => {
                                        hideLoading();
                                    });
                            }}>
                                开始下载
                            </Button>
                            <Button variant="primary" onClick={handleClose}>
                                关闭
                            </Button>
                        </Modal.Footer>
                    </Modal>

                </div >);
        };
        const LocalTasks = () => {
            const [show, setShow] = useState(false);
            const handleClose = () => setShow(false);
            const handleShow = () => setShow(true);
            const [downloads, setDownloads] = useState([])
            const [addDownloadObject, setAddDownloadObject] = useState({})
            const setting = STORE.getState().settings;
            const columns = [
                { title: "文件名称", dataIndex: "name" },
                { title: "大小", dataIndex: "size", render: (row) => (bytesToSize(row.size)) },
                { title: "日期", dataIndex: "created", render: (row) => (formatDate(row.created)) },
                {
                    title: "操作",
                    dataIndex: "name",
                    render: (row) => (
                        <div>
                            <Icon
                                icon="delete-outline"
                                size="6"
                                className="me-2"
                                onClick={() => {
                                    layer.confirm('确定删除？该操作无法撤销!!!', { icon: 3 }, function (index) {
                                        setDownloads(
                                            downloads.filter(a =>
                                                a.name !== row.name
                                            )
                                        );
                                        layer.close(index);
                                    }, function () {

                                    });
                                }}
                            />

                            <Button
                                data-clipboard-text={row.url}
                                className="border-0 copybtn p-0 m-0 bg-transparent me-2">
                                <Icon
                                    icon="content-copy"
                                    size="6"
                                    className="text-black"
                                />
                            </Button>



                            <Icon
                                icon="pencil-outline"
                                size="6"
                                className="me-2"
                                onClick={() => {
                                    layer.prompt({
                                        title: '输入文件名称，并确认',
                                        formType: 0,
                                        value: row.name,
                                        success: function (layero, index) {
                                            $(".layui-layer").eq(0).css("top", "0px");
                                            $("div[aria-modal]").eq(0).removeAttr("tabindex");//解决弹出窗的input无法获取焦点的问题
                                        },
                                        end: function (layero, index) {
                                            $("div[aria-modal]").eq(0).attr("tabindex", -1).focus();//再把焦点还回去
                                        }
                                    }, function (value, index) {
                                        const newDownloads = downloads.map(downloadItem => {
                                            if (downloadItem.name === row.name) {
                                                return {
                                                    ...downloadItem,
                                                    name: value
                                                };
                                            }
                                            return downloadItem;
                                        });
                                        setDownloads(newDownloads);
                                        layer.close(index);
                                    });
                                }}
                            />
                        </div>
                    ),
                },
            ];


            const { mutateAsync: localTaskdMutation } = useMutation({
                mutationKey: ["get-download"],
                mutationFn: async () => {
                    showLoading();
                    var host = setting.directus_host;
                    if (!host.endsWith("/")) {
                        host = host + '/'
                    }
                    var url = host + 'items/task';
                    const tasks = downloads.map(task => {
                        return { url: task.url + '##' + task.name }
                    })
                    return await axios.post(url, tasks, {
                        headers: {
                            'Authorization': "Bearer " + setting.directus_token,
                            'Content-Type': 'application/json'
                        },
                    })
                },
                onSuccess: async (data, variables, context) => {
                    hideLoading();
                    layer.msg('任务添加成功', { time: 2000, icon: 6 });
                },
                onError: () => {
                    hideLoading();
                    layer.msg('任务添加失败', { time: 2000, icon: 5 });
                }
            })
            const addDowload = (fileinfo) => {
                const download = { name: fileinfo.name, size: Number(fileinfo.size), url: fileinfo.url, created: fileinfo.create_ts }
                setAddDownloadObject(download)
            }
            useEffect(() => {
                if (addDownloadObject && ('name' in addDownloadObject)) {
                    setDownloads([...downloads, addDownloadObject])
                    setAddDownloadObject({})
                }
            }, [addDownloadObject]);
            useEffect(() => {
                onEvent("addDownload", addDowload)
                settingStorage.getItem('downloads').then(function (value) {
                    if (value) {
                        setDownloads(value)
                    }
                }).catch(function (err) {
                    console.log(err)
                });
            }, []);
            useEffect(() => {
                settingStorage.setItem('downloads', downloads)
            }, [downloads]);


            if (downloads.length > 0) {
                return (
                    <div>
                        <Button
                            style={{
                                backgroundColor: "transparent",
                            }}
                            className="nav-link btn"
                            onClick={handleShow}
                            children={
                                <span>
                                    <Icon
                                        icon="download"
                                        size="3"
                                        className="text-white"
                                    />
                                    <Badge bg="danger" style={{ top: '-15px', left: '-10px' }}>{downloads.length}</Badge>
                                </span>
                            }
                        ></Button>


                        <Modal show={show} onHide={handleClose}>
                            <Modal.Header closeButton>
                                <Modal.Title>本地下载任务</Modal.Title>
                            </Modal.Header>
                            <Modal.Body>
                                {downloads && (
                                    <DataTable data={downloads ? downloads : []} columns={columns} />
                                )}
                            </Modal.Body>
                            <Modal.Footer className="justify-content-between">

                                <ButtonGroup>
                                    <Button variant="primary" onClick={async () => { await localTaskdMutation() }}>
                                        添加转存
                                    </Button>
                                </ButtonGroup>

                                <ButtonGroup>
                                    <Button variant="danger" onClick={() => {
                                        layer.confirm('确定删除？该操作无法撤销!!!', { icon: 3 }, function (index) {
                                            setDownloads([]);
                                            layer.close(index);
                                        }, function () {

                                        });
                                    }}>
                                        清空
                                    </Button>
                                    <Button variant="primary" onClick={handleClose}>
                                        关闭
                                    </Button>
                                </ButtonGroup>


                            </Modal.Footer>
                        </Modal>

                    </div >
                );
            }
        }


        const container = document.getElementById("root");
        const root = ReactDOM.createRoot(container);
        root.render(
            <QueryClientProvider client={queryClient}>
                <HashRouter>
                    <Route path="/:path?">
                        <Layout>
                            <Switch>
                                <Route path="/" exact component={Videos} />
                                <Route path="/shares" exact component={Shares} />
                                <Route path="/trash" exact component={Trash} />
                                <Route path="/webdav" exact component={WebDav} />
                                <Route path="/offlinetask" exact component={OfflineTask} />
                                <Route path="/videos/*" component={Videos} />
                            </Switch>
                        </Layout>
                    </Route>
                </HashRouter>
            </QueryClientProvider>
        );

        var clipboard = new ClipboardJS('.copybtn');

        clipboard.on('success', function (e) {
            layer.msg("复制成功");
            e.clearSelection();
        });

        clipboard.on('error', function (e) {
            layer.msg("复制失败");
        });

        $(document).ready(function () {
            $(window).scroll(function () {
                if ($(this).scrollTop() > 50) {
                    $("#back-to-top").fadeIn();
                } else {
                    $("#back-to-top").fadeOut();
                }
            });
            // scroll body to 0px on click
            $("#back-to-top").click(function () {
                $("body,html").animate(
                    {
                        scrollTop: 0,
                    },
                    400
                );
                return false;
            });
        });
    </script>
</body>

</html>
